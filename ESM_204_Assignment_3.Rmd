---
title: "ESM_204_Assignment_3"
author: "Annie Combs"
date: "May 7, 2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

```{r}
library(tidyverse)
library(rootSolve)
library(janitor)
library(tibble)
```

```{r}
df <-read_csv("HW3_data.csv") %>%
  select(-1) %>%
  clean_names()
```
```{r}
model_dem_low <-lm(price_cents ~ q_low_kwh, data = df)
model_dem_high <-lm(price_cents ~ q_high_kwh, data = df)
```
Need to rearrange the parameter to get Q(P)! 

Qgg = Qlow(P) + Qlow(P) 

Importantly, since they-intercepts are different, we know that Qagg(P) will have a kink. ifelse() statement will take care of the kink.

Define a function to get demand in terms of Q
```{r}
demand <-function(p, model){
  q <- (p - model$coefficients[[1]])/model$coefficients[[2]] 
  q <- ifelse(q<0,0,q)
  return(q)}

demand_l_2 <- demand(p=2, model = model_dem_low)

demand_h_2 <- demand(p=2, model = model_dem_high)

```

```{r}
# for each p level, return estimated aggregate demand
demand_agg <- function(p){
  q <- demand(p, model_dem_low) + demand(p, model_dem_high)
  return(q)}

```

```{r}
price = seq(0, model_dem_high$coefficient[1], length.out = 100)
Qagg <- map(price, demand_agg) %>% 
  unlist()

df<- tibble(Qagg = Qagg, price = price)

ggplot(df, aes(Qagg, price)) +
  geom_line()
```

# I also define functions for calculating the consumer surplus:

```{r}
CS <- function(p, model){
  q <- demand(p, model)
  cs <- 0.5*(model$coefficients[[1]] - p)*q
  return(cs)}

CS_agg <- function(p){
  cs <- CS(p,model_demand_l) + CS(p,model_demand_h)
  return(cs)}
```

```{r}

#demand function
demand <- function(p, model){
  q <- (p - model$coefficients[[1]])/model$coefficients[[2]]
  q <- ifelse(q<0,0,q)
  return(q)
}
#aggregate demand
demand_agg <- function(p){
  q <- demand(p, model_dem_low) + demand(p, model_dem_high)
  return(q)
}
#price vector
price = seq(0, 30, length.out = 100)
#applying the aggregate demand function to the price vector
Qagg <- map(price, demand_agg) %>% unlist()
#making the new dataframe with Qagg and price
agg_data<- tibble(Qagg = Qagg, price = price)
#making predicted dataframes with low and high models
l_pred <- tibble(price = price,
                 demand = demand(price, model_dem_low))
l_pred[l_pred == 0] <- NA
h_pred <- tibble(price = price,
                 demand = demand(price, model_dem_high))
#MPC line
qfm <- demand_agg(10)
MPC_slope <- 10/qfm
supply <- function(q){
  p <- MPC_slope * q
  return(p)
}
MPC <- tibble(price = supply(agg_data$Qagg),
              demand = agg_data$Qagg)
#plot
ggplot() +
  geom_line(agg_data, mapping = aes(x = Qagg, y = price, color = "Aggregate", lty = "Aggregate")) +
  geom_line(l_pred, mapping = aes(x = demand, y = price, color = "Low income", lty = "Low income")) +
  geom_line(h_pred, mapping = aes(x = demand, y = price, color = "High income", lty = "High income")) +
  geom_line(Dagg_new, mapping = aes(x = Qagg, y= price, color = "New Aggregate", lty = "New Aggregate")) +
  geom_line(MPC, mapping = aes(x = demand, y = price, color = "MPC", lty = "MPC")) +
  geom_segment(aes(x = 0, y = 1.8, xend = 819713.75, yend = 1.8, color = "MEC", lty = "MEC")) +
  geom_line(MPC, mapping = aes(x = demand, y = price + 1.8, color = "MSC", lty = "MSC")) +
  labs(x = "Quantity (kWh)",
       y = "Price (cents)",
       color = "Demand Curve") +
  theme_minimal()
```

### 1. One kWh of electricity emits 0.85 pounds of CO2. Assuming that the interim SCC correctly reflects the total social cost of one metric ton of CO2, what is the marginal externality cost per kwH of electricity?

```{r echo=FALSE}

# Price of CO2 per lb, 1MT = 2204.62 lb,  $51 per MT of CO2

mt_lb <- 2204.62    # Metric Ton (MT) in lbs

P_lbco2 <- 51*mt_lb   # CO2 - price per lb ($/lb)

C_emit_per_kwh <- 0.85     # 1kWh = 0.85lb CO2, 0.85lb/kWh

#  will need this function in #4
mec_f <- function(SCC) {              #  cents/kWh = ($/MT / (lb/MT)  * lb/kWh) * 100
  round((SCC / mt_lb * C_emit_per_kwh) * 100, 3) 
 
}      

mec51 <- mec_f(51)   # SCC = $51 per MT

```


- Convert 0.85 lbCO2 to metric ton (ton) CO2

0.85 lb CO2 x 0.000453592 ton CO2/lb CO2

= 0.0003855535 ton CO2 / Kwh

- Multiply ton value by price per ton CO2 to get the marginal cost of the externality

0.0003855535 ton CO2 / Kwh x $51 / ton CO2

= $0.01966305 / ton CO2 x Kwh

#### The MEC is `r mec51` cents per Kwh electricity

# --

```{r}
MEC <- mec51
```


#2. What is the aggregate monthly demand curve for electricity? What is the supply curve for electricity? What is the “benefit” to consumers under the status quo? What is the “benefit” to producers under the status quo? What is the environmental cost under the status quo?

```{r}

# ASSUMING STATUS QUO IS WITH NOT MEC APPLIED - DO WE AGREE?
#I agree! But does it make sense to have the status quo be BAU (0.85Q)?

# P = mQ + b

ml <- model_dem_low$coefficient[2]  # slope of DL
bl <- model_dem_low$coefficient[1]  # P int of DL

mh <- model_dem_high$coefficient[2]  # slope of DH
bh <- model_dem_high$coefficient[1]  # P int of DH

# P = mQ + b
# Q = P/m - b/m
# Ql = P/ml - bl/ml , Qh = P/mh - bh/mh
# Q = P/ml + P/mh - bl/ml - bh/mh 
# Q = P*(ml + mh)/(ml*mh) - (bl/ml + bh/mh) 
# Q = Sagg * P - Qint for Q > Qh_k

Sagg <- (ml + mh)/(ml*mh)  # Slope of Qagg, Q > Qh_k
Magg <- 1/Sagg             # Slope of Dagg, Q > Qh_k
Qint <- -(bl/ml + bh/mh)  # Neg?  Only works this way

# find Q at kink in Dagg at dem_low intercept (P = bl)
# P = dem_high = bl = mhQh_k + bh 
# Qh_k = (bl - bh)/mh


Qh_k <- (bl - bh)/mh     # kink point of Dagg

# Q <- Sagg * P - Qint

# Dagg = P from above, P = (Q + Qint)/Sagg = (Magg)*(Q + Qint)
 
# Dagg <- Magg*(Q + Qint)

Dagg_d <- tibble(Q = seq(round(Qh_k, 0), Qint, 100))

Dagg_d <- Dagg_d %>% 
  mutate(price = Magg*(Q - Qint))

Dagg <- lm(price ~ Q, data = Dagg_d)  # Linear regression for Dagg(P) for Q > 158,329

P_e <- 10    # current price of electricity in cents

# Supply (MPC) goes thru P_e at Dagg and origin using Qagg = Sagg * P + Qint.  
# Q_p_e is the run (Q) and P_e is the rise (P) for MPC, Oint = 0.

Q_p_e <- Sagg*P_e + Qint   # Plug P-e into above equation to get intersection Q point

m_MPC <- P_e / Q_p_e    # Slope of Supply (MPC)

MPC_d <- tibble(Q = seq(0, Qint, 100))   # MPC data

MPC_d <- MPC_d %>% 
  mutate (price = m_MPC * Q)

MPC <- lm(price ~ Q, data = MPC_d)  # MPC Linear regression

MPC
```

```{r}
CS <- function(p, model){
  q <- demand(p, model)
  cs <- 0.5*(model$coefficients[[1]] - p)*q
  return(cs)}

CS_agg <- function(p){
  cs <- CS(p,model_dem_low) + CS(p,model_dem_high)
  return(cs)}
  

CS_agg_sq <-CS_agg(10)  # current price is 10 cents


PS <- function(p, model){
  q <- demand(p, model)
  ps <- 0.5 * p * q
  return(ps)}

PS_agg <- function (p){
  ps <- PS(p,model_dem_low) + PS(p,model_dem_high)
  return(ps)}

PS_sq <- PS(10, Dagg)

PS_agg_sq <- PS_agg(10)

EC <- function(p, model, mec){
  q <- demand(p, model)
  ec <- 0.5 * (p - mec) * q + mec * q
  return(ec)}

EC_sq <- EC(10, MPC, 0)

```

# Graph the new Demand Curves (with tax)
```{r}
Dagg_new <- agg_data - MEC

low_dem_new <- l_pred - MEC

high_dem_new <- h_pred - MEC

ggplot(Dagg_new) +
  geom_line(low_dem_new, mapping = aes(x = demand, y= price, color = "New Low", lty = "New Low")) +
  geom_line(Dagg_new, mapping = aes(x = Qagg, y= price, color = "New Aggregate", lty = "New Aggregate")) +
  geom_line(h_pred, mapping = aes(x = demand, y= price, color = "New High", lty = "New High"))
  
```

#### Aggregate Demand Curve: 
#### Dagg = `r round(model_dem_high$coefficient[2], 5)`*Q + `r round(model_dem_high$coefficient[1], 1)` for Q < `r Qh_k`
#### Dagg = `r round(Dagg$coefficient[2], 5)`*Q + `r round(Dagg$coefficient[1], 1)` for Q > `r Qh_k`

#### Current supply curve: MPC = `r round(MPC$coefficient[2], 5)`*Q + `r round(MPC$coefficient[1], 1)`

#### Consumer Benefit: `r round(CS_agg_sq, 0)`

#### Producer Benefit: `r round(PS_agg_sq, 0)`

#### Environmental cost: `r round(EC_sq, 0)`


#--

#3. How is the current consumer benefit divided between “high” and “low” income consumers?

```{r}


CS_l_sq <- CS(10, model_dem_low)  # consumer benefit to low income

CS_h_sq <- CS(10, model_dem_high)

CS_l_p <- (CS_l_sq / CS_agg_sq) * 100   # Percent benefit to low income

CS_h_p <- (CS_h_sq / CS_agg_sq) * 100

```


#### Consumer Benefit Split:  `r round(CS_l_p, 1)`% Low &  `r round(CS_h_p, 1)`% High
# --

#4. Derive the optimal electricity tax (in cents per kWh) using the interim SCC. Noting that recent research has shown the poor face a disproportionate share of the impacts from climate change, assume that the climate externality is borne entirely by the “low” income group. What would be the effects of this tax on:

#(a) The amount of electricity produced and consumed

```{r}
Qtax <- function(p){
  q <- (Dagg$coefficient[1] - MEC) / (m_MPC - Magg)
  return(q)
}

Qtax <- Qtax(51)
Qtax

```
<<<<<<< HEAD

Qtax is 500290.5 
=======
### The amount of electricity produced and consumed is equal to `r Qtax`
>>>>>>> 90c6a58ee93ea01c8d4b066741ab50479d7021ca

#(b) The price of electricity
```{r}
Ptax <- function(q){
  p <- ((Qtax * m_MPC) - MEC)
  return(p)
}
Ptax <- Ptax(Qtax)
Ptax
```

Ptax is 7.36 cents

The price of electricity is `r Ptax`


#(c) Overall welfare of “high” income consumers
```{r}

```

#(d) Overall welfare of “low” income consumers

#(e) Power suppliers (i.e., electricity producers)

#(f) Total environmental damage

#(g) Total tax revenue generated

#5. Now, assume that all revenue from the electricity tax will be redistributed to the consumers in proportion to their pre-tax consumption. For example, if 80% of the electricity was consumed by “high” income consumers, then they get 80% of the tax revenue. Additionally, consider the fact that current scientific evidence suggests the true SCC may be much higher than $51. For a range of SCC values ($51, $75, $100, $125, and $150 per metric ton of CO2), calculate the effects of an SCC-based electricity tax on:

```{r}

MSC_F <- function(mec) {          # function to calculate MSC at different
  mscF <- MPC_d %>% 
  mutate(price = price + mec)
  lm(price ~ Q, data = mscF)      # put in function, so have no data table
}

MSC51 <- MSC_F(mec51)             # Marginal Social Cost linear regression SCC of 51

# MSC <- lm(price ~ Q, data = mscF)

mec75 <- mec_f(75)    # maybe these two functions can be combined?
MSC75 <- MSC_F(75)    

mec100 <- mec_f(100)
MSC100 <- MSC_F(100)

mec125 <- mec_f(125)
MSC125 <- MSC_F(125)

mec150 <- mec_f(150)
MSC150 <- MSC_F(150)
```

# The tax should be where the MEC meets the Q star (socially optimal quantity). In this case, the MEC is a straight, horizontal line, so the t star will simply equal around 2 cents per Kwh electricity. 

# Graph the demand curves and the aggregate in one graph with the MES, MSC, and MPC

```{r}
ggplot() +
  geom_line(low_dem_new, mapping = aes(x = demand, y= price, color = "New Low")) +
  geom_line(Dagg_new, mapping = aes(x = Qagg, y= price, color = "New Aggregate")) +
  geom_line(h_pred, mapping = aes(x = demand, y= price, color = "New High"))+
   geom_line(agg_data, mapping = aes(x = Qagg, y = price, color = "Aggregate")) +
  geom_line(l_pred, mapping = aes(x = demand, y = price, color = "Low income")) +
  geom_line(h_pred, mapping = aes(x = demand, y = price, color = "High income")) +
  geom_line(MPC, mapping = aes(x = demand, y = price, color = "MPC")) +
  geom_segment(aes(x = 0, y = 1.8, xend = 819713.75, yend = 1.8, color = "MEC")) +
  geom_line(MPC, mapping = aes(x = demand, y = price + 1.8, color = "MSC")) +
  labs(x = "Quantity (kWh)",
       y = "Price (cents)",
       color = "Demand Curve") +
  theme_minimal()
```

## Step 1: graph demand curves (see above)


#(a) Overall welfare of “high” income consumers

#(b) Overall welfare of “low” income consumers
- CS for low income consumers (will graph)
#(c) Electricity producers
- PS for electricity producers (will graph)

#6. Suppose the “high” income group has access to expensive home solar generation. This lowers the electricity demand curve for the “high” income group by half (vertically). Under this new demand:
#(a) What is total electricity consumption?

#(b) What is the total environmental externality?

#(c) What value of the electricity tax makes the total environmental damage the same as the damage when solar panels are available to the high income group?

Graphs if we want to show any.  It doesn't ask for any.  We would need to convert lms to dfs where we don't have them.  Maybe the extra work isn't worth it but wouldn't take much.
- I agree that this might be super helpful. If it isn't too much extra trouble, I say we do it.
```{r}

MEC51 <- tibble(Q = seq(0, Qint, 100), price = mec51)

 # Join MC Data into one dataset for plotting

join_data <- bind_rows(#'Low' = model_dem_low, 
                       #'High' = model_dem_high,
                       'Dagg' = Dagg_d,
                       "MPC(S)" = MPC_d,
                       "MEC51" = MEC51,
                       #"MSC51" = MSC51,
                       .id = 'Curves')

ggplot(data = join_data, aes(x = Q, 
                             y = price, 
                             color = Curves)) +
  geom_line()
```
